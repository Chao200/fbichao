---
title: 进程和线程
tags:
  - 进程
  - 线程
author: fbichao
categories: 
  - 操作系统
  - 虚拟 CPU
excerpt: 进程和线程
math: true
date: 2024-03-27 21:45:00
---
# 进程

代码只是一个存储在硬盘的静态文件，通过编译后就会生成二进制的可执行文件，当我们运行这个可执行文件后，它会被装载到内存中，接着 CPU 会执行程序中的每一条指令，那么这个运行中的程序，就被称为「进程」（Process）。

## 1. 并行和并发

并行指多个 CPU 同时执行多个任务，并发指一个 CPU 在某个时间段内执行多个任务

并发其实是为了实现虚拟 CPU，让单核 CPU 可以在很短的时间内运行多个程序，达到并行的错觉

## 2. 进程的状态

![](https://file.fbichao.top/2024/03/da66c6449d6211a27f8c6f7becbbe70e.png)

- 阻塞挂起状态：进程在外存（硬盘）并等待某个事件的出现；
- 就绪挂起状态：进程在外存（硬盘），但只要进入内存，即刻立刻运行；

**「为什么要挂起」**

- 进程所使用的内存空间不在物理内存，避免过多的进程占用物理内存
- 通过 sleep 让进程间歇性挂起，其工作原理是设置一个定时器，到期后唤醒进程。
- 用户希望挂起一个程序的执行，比如在 Linux 中用 Ctrl+Z 挂起进程；

## 3. 进程控制结构

在操作系统中，是用 **「进程控制块（process control block，PCB）」** 数据结构来描述进程的。

**进程描述信息：**

* 进程标识符（PID）：标识各个进程，每个进程都有一个并且唯一的标识符；
* 用户标识符（UID）：进程归属的用户，用户标识符主要为共享和保护服务；

**进程控制和管理信息：**

* 进程当前状态，如 new、ready、running、waiting 或 blocked 等；
* 进程优先级：进程抢占 CPU 时的优先级；

**资源分配清单：**

* 有关内存地址空间或虚拟地址空间的信息，所打开文件的列表和所使用的 I/O 设备信息。

**CPU 相关信息：**

* CPU 中各个寄存器的值，当进程被切换时，CPU 的状态信息都会被保存在相应的 PCB 中，以便进程重新执行时，能从断点处继续执行。

## 4. 进程上下文切换

进程的上下文切换不仅包含了

- 虚拟内存、栈、全局变量等**用户空间**的资源
- 还包括了内核堆栈、寄存器等**内核空间**的资源。

> 通常，会把交换的信息保存在进程的 PCB，当要运行另外一个进程的时候，我们需要从这个进程的 PCB 取出上下文，然后恢复到 CPU 中，这使得这个进程可以继续执行，

## 5. 何时发生上下文切换

- 时间片耗尽
- 内存不足，挂起
- 主动挂起（sleep）
- 被其他进程抢占 CPU
- 硬件中断

# 线程

线程是进程当中的一条执行流程。

同一个进程内多个线程之间可以共享代码段、数据段、打开的文件等资源，但每个线程各自都有一套独立的寄存器和栈，这样可以确保线程的控制流是相对独立的。

![](https://file.fbichao.top/2024/03/60385a887526f8b35b3043bc0a1c2afc.png)

## 1. 线程的优点

一个进程中可以同时存在多个线程；
各个线程之间可以并发执行；
各个线程之间可以共享地址空间和文件等资源；

## 2. 线程的缺点

当进程中的一个线程崩溃时，会导致其所属进程的所有线程崩溃（C++ 是的，Java 不是）

## 3. 进程和线程比较

- 进程是资源（包括内存、打开的文件等）分配的单位，线程是 CPU 调度的单位；
- 进程拥有完整的资源，而线程只独享必不可少的资源，如寄存器和栈；
- 线程同样具有就绪、阻塞、执行三种基本状态，同样具有状态之间的转换关系；
- 线程能减少并发执行的时间和空间开销；

**减少开销**

- 创建：线程的创建时间比进程快，因为进程在创建的过程中，还需要资源管理信息，比如内存管理信息、文件管理信息，而线程在创建的过程中，不会涉及这些资源管理信息，而是共享它们；
- 终止：线程的终止时间比进程快，因为线程释放的资源相比进程少很多；
- 切换：同一个进程内的线程切换比进程切换快，因为线程具有相同的地址空间（虚拟内存共享），这意味着同一个进程的线程都具有同一个页表，那么在切换的时候不需要切换页表。而对于进程之间的切换，切换的时候要把页表给切换掉，而页表的切换过程开销是比较大的；
- 通信：由于同一进程的各线程间共享内存和文件资源，那么在线程之间数据传递的时候，就不需要经过内核了，这就使得线程之间的数据交互效率更高了；

## 4. 线程上下文切换

> 线程与进程最大的区别在于：线程是调度的基本单位，而进程则是资源拥有的基本单位。

所谓操作系统的任务调度，实际上的调度对象是线程，而进程只是给线程提供了虚拟内存、全局变量等资源。

- 当两个线程不是属于同一个进程，则切换的过程就跟进程上下文切换一样；
- 当两个线程是属于同一个进程，只需要切换线程的栈、寄存器等不共享的数据；

## 5. 线程的实现

- **用户线程（User Thread）**：在用户空间实现的线程，不是由内核管理的线程，是由用户态的线程库来完成线程的管理；
- **内核线程（Kernel Thread）**：在内核中实现的线程，是由内核管理的线程；
- **轻量级进程（LightWeight Process）**：在内核中来支持用户线程；

# 总结

进程是系统资源分配和调度的基本单位，而线程是 OS 能够进行运算和调度的最小单位

一个进程可以有多个线程，并且多个线程共享一些内存，每个线程也有各自独立的栈和寄存器

进程创建、销毁和切换的开销较大，线程较小

进程间通信需要特殊机制，如管道、消息队列、共享内存等，线程共享内存，可以直接访问彼此数据

进程之间相互隔离，一个进程崩溃不会影响别的进程，而由于共享内存，一个线程出错，可能影响整个进程的稳定性


七态模型，挂起是将进程放在磁盘
