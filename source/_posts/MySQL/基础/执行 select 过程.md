---
title: 执行 select 过程
tags:
  - 执行 select 过程
author: fbichao
categories: 
  - MySQL
  - 基础
excerpt: 
math: true
date: 2024-03-19 21:45:00
---
![](https://file.fbichao.top/2024/03/11a6677aab9b32811a493e7986b7cfd8.png)

MySQL 架构分为 **Server 层** 和 **存储引擎层**

- Server 层负责建立连接、分析执行 SQL 语句
- 存储引擎层负责数据的存储和提取

## 1. 连接器

> 和客户端建立连接、获取权限

- 与客户端进行 TCP 三次握手建立连接；
- 校验客户端的用户名和密码，如果用户名或密码不对，则会报错；
- 如果用户名和密码都对了，会读取该用户的权限，然后后面的权限逻辑判断都基于此时读取到的权限；

1. 空闲连接不会一直占用内存，超时自动关闭
2. 连接数量有限制
3. 长连接和短连接

### 长连接占用内存

MySQL 在执行查询过程中临时使用内存管理连接对象，这些连接对象资源只有在连接断开时才会释放。如果长连接累计很多，将导致 MySQL 服务占用内存太大，有可能会被系统强制杀掉，这样会发生 MySQL 服务异常重启的现象。

如何解决长连接？

- 定期断开长连接
- 客户端主动重置长连接，使用 mysql_reset_connection() 函数

## 2. 缓存

对于更新比较频繁的表，查询缓存的命中率很低的

MySQL8.0 将查询缓存删除了

## 3. 解析 SQL

词法分析、语法分析

## 4. 执行 SQL

- prepare 阶段，也就是预处理阶段；
- optimize 阶段，也就是优化阶段；
- execute 阶段，也就是执行阶段；

### 预处理

- 检查 SQL 查询语句中的表或者字段是否存在；
- 将 select * 中的 * 符号，扩展为表上的所有列；

### 优化器

优化器主要负责将 SQL 查询语句的执行方案确定下来

- 索引的选择
- 多表连接的顺序

### 执行器

- 主键索引查询
- 全表扫描
- 索引下推

## 执行 update 呢

增加更新日志步骤 redolog 和 binlog、undolog

## 总结

- 连接器：建立连接，管理连接、校验用户身份；
- 查询缓存：查询语句如果命中查询缓存则直接返回，否则继续往下执行。MySQL 8.0 已删除该模块；
- 解析 SQL：通过解析器对 SQL 查询语句进行词法分析、语法分析，然后构建语法树，方便后续模块读取表名、字段、语句类型；
- 执行 SQL：执行 SQL 共有三个阶段：
  - 预处理阶段：检查表或字段是否存在；将 select * 中的 * 符号扩展为表上的所有列。
  - 优化阶段：基于查询成本的考虑， 选择查询成本最小的执行计划；
  - 执行阶段：根据执行计划执行 SQL 查询语句，从存储引擎读取记录，返回给客户端；
