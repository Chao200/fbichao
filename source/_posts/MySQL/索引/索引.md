---
title: 索引
tags:
  - 索引
author: fbichao
categories: 
  - MySQL
  - 索引
excerpt: 
math: true
date: 2024-03-20 21:45:00
---

# 索引分类

![](https://file.fbichao.top/2024/03/b50cdc7570cce03d43f37a0622767e39.png)

## 1. 数据结构

- B+Tree 索引
- Hash 索引
- Full-Text 索引


如果有主键，默认会使用主键作为聚簇索引的索引键（key）；
如果没有主键，就选择第一个不包含 NULL 值的唯一列作为聚簇索引的索引键（key）；
在上面两个都没有的情况下，InnoDB 将自动生成一个隐式自增 id 列作为聚簇索引的索引键（key）；

## 2. 物理存储

- 聚集/主键索引

    聚集/主键索引的 B+Tree 的叶子节点存放的是实际数据，所有完整的用户记录都存放在主键索引的 B+Tree 的叶子节点里；

- 二次索引

    二级索引的 B+Tree 的叶子节点存放的是主键值，而不是实际数据。

## 3. 字段特性

- 主键索引
- 唯一索引
- 普通索引
- 前缀索引

## 4. 字段个数

- 单列索引
- 联合索引


### 最左匹配原则

> 在 B+TREE 的叶子结点，先按照首个字段排序，再按照第二个字段排序，如果查询时没有首个字段，则后续字段是**全局无序的，局部相对有序**的

- 遇到范围查询（如 >、<）的时候，就会停止匹配，也就是范围查询的字段可以用到联合索引，但是在范围查询字段的后面的字段无法用到联合索引
- 注意，对于 >=、<=、BETWEEN、like 前缀匹配的范围查询，并不会停止匹配
- like 后缀匹配，会停止


# 为什么选择 B+Tree

- 对比二叉树

B+Tree 是 N 叉树，当数据量很大的时候，二叉树的层次就会**很深**，查询就会很慢

- B Tree

1. B+Tree 只在叶子节点存储数据，非叶子结点存储索引，而 B 树 的非叶子节点也要存储数据，所以 B+Tree 的单个节点的数据量更小，在相同的磁盘 I/O 次数下，就能**查询更多的节点**。

2. B+Tree 叶子节点采用的是双链表连接，适合基于**范围的顺序查找**，而 B 树无法做到这一点。

- Hash

hash 在等值查询的时候是 $O(1)$，但是不适用于范围查询


# 什么时候不需要/需要索引


## 0. 索引缺点

- 需要占用物理空间，数量越大，占用空间越大；
- 创建索引和维护索引要耗费时间，这种时间随着数据量的增加而增大；
- 会降低表的增删改的效率，因为每次增删改索引，B+ 树为了维护索引有序性，都需要进行动态维护。

## 1. 需要索引

- 字段有唯一性限制的，比如商品编码；
- 经常用于 WHERE 查询条件的字段，这样能够提高整个表的查询速度，如果查询条件不是一个字段，可以建立联合索引。
- 经常用于 GROUP BY 和 ORDER BY 的字段，这样在查询的时候就不需要再去做一次排序了，因为我们都已经知道了建立索引之后在 B+Tree 中的记录都是排序好的。

## 2. 不需要索引

- WHERE 条件，GROUP BY，ORDER BY 里用不到的字段，索引的价值是快速定位，如果起不到定位的字段通常是不需要创建索引的，因为索引是会占用物理空间的。
- 字段中存在大量重复数据，不需要创建索引，比如性别字段，只有男女，如果数据库表中，男女的记录分布均匀，那么无论搜索哪个值都可能得到一半的数据。在这些情况下，还不如不要索引，因为 MySQL 还有一个查询优化器，查询优化器发现某个值出现在表的数据行中的百分比很高的时候，它一般会忽略索引，进行全表扫描。
- 表数据太少的时候，不需要创建索引；
- 经常更新的字段不用创建索引，比如不要对电商项目的用户余额建立索引，因为索引字段频繁修改，由于要维护 B+Tree的有序性，那么就需要频繁的重建索引，这个过程是会影响数据库性能的。



# 优化索引的方法

- 前缀索引优化；
- 覆盖索引优化；
- 主键索引最好是自增的；
- 防止索引失效；


## 1. 前缀索引优化

使用某个字段中字符串的前几个字符建立索引，减小索引字段大小，可以增加一个索引页中存储的索引值

- order by 就无法使用前缀索引；
- 无法把前缀索引用作覆盖索引；

## 2. 覆盖索引优化

指 SQL 中查询的所有字段，在索引 B+Tree 的叶子节点上都能找得到的那些索引，不需要回表查询

## 3. 主键索引最好是自增的

如果我们使用自增主键，每次插入一条新记录，都是追加操作，不需要重新移动数据

如果我们使用非自增主键，可能导致页分裂。页分裂还有可能会造成大量的内存碎片，导致索引结构不紧凑，从而影响查询效率。

## 4. 防止索引失效

### 索引失效

- 当我们使用左或者左右模糊匹配的时候，也就是 `like %xx` 或者 `like %xx%` 这两种方式都会造成索引失效；
- 当我们在查询条件中对索引列做了计算、函数、类型转换操作，这些情况下都会造成索引失效；
- 联合索引要能正确使用需要遵循最左匹配原则，也就是按照最左优先的方式进行索引的匹配，否则就会导致索引失效。
- 在 WHERE 子句中，如果在 OR 前的条件列是索引列，而在 OR 后的条件列不是索引列，那么索引会失效。


# 索引下推

在不满足最左前缀匹配时，在联合索引遍历过程中，对联合索引中包含的字段先判断，直接过滤掉不满足条件的记录，减少回表次数

# 总结

![](https://file.fbichao.top/2024/03/ebcda5575ac5dca3e3e418d1d4735ce1.png)