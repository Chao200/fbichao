---
title: 锁
tags:
  - 全局锁
  - 表级锁
  - 行级锁
author: fbichao
categories: 
  - MySQL
  - 锁
excerpt: 
math: true
date: 2024-03-18 21:45:00
---

![](https://file.fbichao.top/2024/03/a48bfa037fa43b1856723d08da939aa8.png)
# 全局锁

对整个数据库实例加锁

用于全库逻辑备份

备份数据库之前先开启事务，会先创建 Read View，然后整个事务执行期间都在用这个 Read View


# 表级锁

## 1. 表锁

将整个表锁住

```mysql
lock tables [] read/write
unlock tables
```

## 2. 元数据锁（Meta Data Lock, MDL）

不需要显示使用，访问一个表会被自动加上

用于对表结构的锁，事务提交后解锁

## 3. 意向锁

对某些记录加锁之前会对表加锁


# 行级锁

> 行锁在需要的时候才加上，得到事务结束才释放锁——**两阶段锁协议**

## 1. 记录锁（Record Lock）

把一条记录上锁

## 2. 间隙锁（Gap Lock）

锁定存储的数据与数据之间的间隙，防止新的数据插入到间隙，只存在于 RR 隔离级别，解决幻读现象

## 3. 临键锁（Next-Key Lock）

记录锁 + 间隙锁的组合


# 加锁规则

> RR 隔离级别

- 加锁基本单位是 next-key lock，即临键锁
- 查找到访问的对象才加锁
- 索引上的等值查询，给唯一索引加锁，next-key lock 退化为行锁
- 索引上的等值查询，给一般索引加锁，向右遍历时且最后一个值不满足等值条件的时候，next-key lock 退化为间隙锁
- 所有加锁的资源，都是在事务提交或回滚才释放



# 锁的划分

## 1. 数据库角度

### 1.1 共享锁

共享锁（读锁、S 锁）
- 锁定的资源可以被其他用户读取，但是不能修改
- 进行 select 时，会将对象进行共享锁锁定，当数据读取完，释放共享锁，保证在读期间不被改变

```mysql
LOCK IN SHARE MODE
```

### 1.2 排它锁

排它锁（独占锁、写锁、X 锁）
- 锁定的数据只允许进行锁定操作的事务使用，其它事务无法对已锁定的数据进行读写
- 在对数据进行 insert、delete、update 的时候，数据库自动使用 X 锁，防止其他事务对该数据进行操作

```mysql
FOR UPDATE
```

### 1.3 区别

- 排它锁是独占的，一个只能由一个事物持有，而共享锁非独占，允许多个事务同时持有相同资源和共享锁
- 排它锁通常用于写操作，共享锁用于读操作


### 1.4 意向锁

> 给更大一级别的空间示意里面是否已经上过锁

当给记录加锁时，会在对应的表加上相应的意向锁


## 2. 程序员角度


### 2.1 悲观锁

悲观锁

- 认为数据会被并发操作修改，通过数据库自身的锁机制实现
- 适用于写操作多的场景


### 2.2 乐观锁

乐观锁

- 认为对同一数据的并发操作不会总发生，不用每次都读数据上锁，不采用数据库自身的锁机制，通过程序实现，可以通过版本号或时间戳机制实现
- 适用于读操作多的场景

